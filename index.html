<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœˆï¸2026è¶Šå—7å¤©6å¤œâœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            color: #333;
            overscroll-behavior-y: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe-top { padding-top: max(env(safe-area-inset-top), 1rem); }
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        
        /* æ–‡å­—å±•é–‹æ”¶åˆæ¨£å¼ */
        .desc-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            white-space: pre-wrap;
            transition: all 0.3s ease;
        }
        .desc-text.expanded {
            -webkit-line-clamp: unset;
        }
        
        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-line {
            position: absolute;
            left: 27px;
            top: 3.5rem;
            bottom: -1rem;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }

        /* è¨ˆç®—æ©Ÿ Modal å‹•ç•« */
        #calc-modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        #calc-modal.hidden-modal { opacity: 0; visibility: hidden; pointer-events: none; }
        #calc-modal.show-modal { opacity: 1; visibility: visible; pointer-events: auto; }
        #calc-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hidden-modal #calc-content { transform: scale(0.9) translateY(20px); }
        .show-modal #calc-content { transform: scale(1) translateY(0); }
        
        /* çµç®—å€å¡Šå‹•ç•« */
        #settlement-details { transition: max-height 0.3s ease-out, opacity 0.3s ease; overflow: hidden; max-height: 0; opacity: 0; }
        #settlement-details.open { max-height: 500px; opacity: 1; }

        /* å¤©æ°£å°å¡å‹•ç•« */
        #weather-widget { transition: all 0.5s ease; }
        .weather-loading { opacity: 0.5; filter: blur(2px); }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden max-w-md mx-auto bg-gray-50 shadow-2xl relative">

    <header class="bg-teal-700 text-white px-5 pt-safe-top pb-4 shadow-md z-50 shrink-0 relative">
        <div class="flex justify-between items-center pt-2">
            <div>
                <h1 class="text-xl font-bold tracking-tight">2026 å³´æ¸¯ 7å¤©6å¤œ</h1>
                <p class="text-teal-100 text-sm opacity-90 mt-1">1/29 (å››) - 2/4 (ä¸‰)</p>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-y-auto relative bg-gray-50 pb-24">
        <div id="loading-msg" class="p-10 text-center text-gray-500">
            è³‡æ–™è¼‰å…¥ä¸­...
        </div>
        
        <div id="view-itinerary" class="tab-content active">
            <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 py-3 shadow-sm">
                <div id="day-selector" class="flex px-4 gap-3 overflow-x-auto hide-scrollbar"></div>
            </div>
            
            <div class="px-4 mt-4">
                <div id="weather-widget" class="bg-gradient-to-r from-blue-500 to-teal-400 rounded-xl p-4 text-white shadow-lg flex justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm" id="weather-location">è¼‰å…¥ä¸­...</span>
                            <span class="text-xs opacity-80" id="weather-date">--/--</span>
                        </div>
                        <div class="flex items-end gap-2">
                            <span class="text-3xl font-black" id="weather-temp">--Â°C</span>
                            <span class="text-sm font-medium opacity-90 mb-1" id="weather-desc">è«‹ç¨å€™</span>
                        </div>
                    </div>
                    <div class="text-4xl relative z-10" id="weather-icon">ğŸŒ¤ï¸</div>
                    
                    <div class="absolute -right-4 -bottom-8 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                </div>
            </div>

            <div id="itinerary-list" class="p-4 space-y-4"></div>
        </div>

        <div id="view-mustbuy" class="tab-content p-5 space-y-4">
            <div class="bg-teal-50 border-l-4 border-teal-500 p-4 mb-4 rounded-r">
                <p class="text-sm text-teal-700 font-bold">ğŸ›’ è³¼ç‰©å°è²¼å£«</p>
                <p class="text-xs text-teal-600 mt-1">å»ºè­°åœ¨æ¼¢å¸‚å ´æˆ– Lotte Mart è³¼è²·ï¼Œè¨˜å¾—è²¨æ¯”ä¸‰å®¶ä¸¦é©åº¦æ®ºåƒ¹ã€‚</p>
            </div>
            <div id="mustbuy-list" class="space-y-6"></div>
        </div>

        <div id="view-accounting" class="tab-content p-5 space-y-4">
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6 relative transition-all duration-300" id="form-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2" id="form-title">
                        ğŸ’¸ æ–°å¢ä¸€ç­†å¸³ç›®
                    </h2>
                    <button id="btn-cancel-edit" onclick="resetFormState()" class="hidden text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full font-bold">
                        âœ• å–æ¶ˆ
                    </button>
                </div>

                <form id="account-form" class="space-y-4" onsubmit="submitExpense(event)">
                    <input type="hidden" id="edit-row-id" value="">

                    <div class="grid grid-cols-2 gap-3">
                         <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                            <input type="date" id="acc-date" required class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾äºº</label>
                            <select id="acc-payer" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="æ¦®">æ¦®</option>
                                <option value="å¦‚">å¦‚</option>
                                <option value="ç¿”">ç¿”</option>
                                <option value="åº­">åº­</option>
                                <option value="ä¸­">ä¸­</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">é …ç›®åç¨±</label>
                        <input type="text" id="acc-item" required placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è¨ˆç¨‹è»Š" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">å¹£åˆ¥</label>
                            <select id="acc-currency" onchange="updateRateDisplay()" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="VND">ğŸ‡»ğŸ‡³ è¶Šç›¾</option>
                                <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">é‡‘é¡</label>
                            <input type="number" id="acc-amount" required placeholder="è¼¸å…¥æ•¸å­—" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                    </div>
                    <p id="acc-rate-hint" class="text-xs text-gray-400 -mt-2 text-right">æ­£åœ¨è®€å–åŒ¯ç‡...</p>
                    
                    <div>
                         <label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label>
                         <input type="text" id="acc-note" placeholder="è©³ç´°èªªæ˜..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    
                    <button type="submit" id="btn-submit-acc" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-md transition-all active:scale-95 flex justify-center items-center gap-2">
                        <span>è¨˜å¸³</span>
                    </button>
                </form>
            </div>

            <div id="expense-summary-card" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-4 hidden">
                <div class="flex justify-between items-center mb-1">
                    <p class="text-xs text-gray-500 font-bold">ç¸½æ”¯å‡º (Total)</p>
                    <div class="flex gap-2">
                        <button onclick="fetchExpenses()" class="text-[10px] text-teal-600 font-bold bg-teal-50 px-2 py-1 rounded-full">â†» æ›´æ–°</button>
                    </div>
                </div>
                <div class="flex justify-between items-end border-b border-gray-100 pb-4 mb-3">
                    <p class="text-3xl font-black text-teal-700" id="total-expense">0</p>
                    <button onclick="toggleSettlement()" id="btn-toggle-settlement" class="text-xs text-blue-600 font-bold flex items-center gap-1 hover:bg-blue-50 px-2 py-1 rounded transition-colors">
                        <span>æŸ¥çœ‹çµç®—</span>
                        <svg class="w-3 h-3 transform transition-transform duration-200" id="arrow-settlement" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>

                <div id="settlement-details" class="space-y-3 text-sm">
                    <div class="bg-gray-50 p-3 rounded-lg text-xs text-gray-500 mb-2">
                        <p>ğŸ’¡ è² æ•¸(<span class="text-green-600 font-bold">ç¶ è‰²</span>)ä»£è¡¨ä»£å¢Šå¤ªå¤šï¼Œæ‡‰æ‹¿å›ï¼›æ­£æ•¸(<span class="text-rose-500 font-bold">ç´…è‰²</span>)ä»£è¡¨æ‡‰æ”¯ä»˜ã€‚</p>
                    </div>
                    <div class="space-y-3" id="split-result-list"></div>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-gray-700 mb-3 px-1">æ¶ˆè²»æ˜ç´°</h3>
                <div id="expense-list" class="space-y-3 pb-10">
                    <div class="text-center text-gray-400 py-4 text-sm">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <div id="view-flights" class="tab-content p-5 space-y-4"></div>

        <div id="view-hotels" class="tab-content p-5 space-y-4"></div>
    </main>

    <button onclick="toggleCalc()" class="fixed bottom-24 right-5 z-40 bg-rose-500 hover:bg-rose-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
    </button>

    <div id="calc-modal" class="fixed inset-0 z-[60] flex items-center justify-center px-4 hidden-modal">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCalc()"></div>
        <div id="calc-content" class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10">
            <div class="bg-teal-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    ğŸ’± åŒ¯ç‡æ›ç®—
                    <span id="rate-status" class="text-[10px] bg-teal-800 px-2 py-0.5 rounded-full font-normal opacity-80">æ›´æ–°ä¸­...</span>
                </h3>
                <button onclick="toggleCalc()" class="text-white/80 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div class="text-center text-sm text-gray-500 mb-2">
                    ç•¶å‰åŒ¯ç‡ï¼š1 TWD â‰ˆ <span id="display-rate" class="font-bold text-teal-600 text-lg">---</span> VND
                </div>

                <div class="space-y-4">
                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‡»ğŸ‡³ è¶Šå—ç›¾ (VND)</label>
                        <input type="number" id="input-vnd" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition-all">
                        <span class="absolute right-4 top-[2.1rem] text-gray-400 text-sm font-bold">â‚«</span>
                    </div>
                    
                    <div class="flex justify-center -my-2 relative z-10">
                        <div class="bg-gray-100 p-2 rounded-full text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                        </div>
                    </div>

                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‡¹ğŸ‡¼ æ–°å°å¹£ (TWD)</label>
                        <input type="number" id="input-twd" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition-all">
                        <span class="absolute right-4 top-[2.1rem] text-gray-400 text-sm font-bold">$</span>
                    </div>
                </div>
                
                <div class="text-xs text-gray-400 text-center mt-4">
                    * åŒ¯ç‡åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›è«‹ä»¥æ›åŒ¯åº—å®¶ç‚ºæº–
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-white border-t border-gray-200 shrink-0 pb-safe z-50 fixed bottom-0 w-full max-w-md">
        <div class="grid grid-cols-5 h-16">
            <button onclick="switchTab('itinerary')" id="btn-itinerary" class="nav-btn flex flex-col items-center justify-center w-full h-full text-teal-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                <span class="text-[10px] font-medium mt-1">è¡Œç¨‹</span>
            </button>
            <button onclick="switchTab('flights')" id="btn-flights" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                <span class="text-[10px] font-medium mt-1">ç­æ©Ÿ</span>
            </button>
            
            <button onclick="switchTab('hotels')" id="btn-hotels" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m8-2a2 2 0 100-4 2 2 0 000 4zm-6-4a2 2 0 110-4 2 2 0 010 4zm6-10a2 2 0 110-4 2 2 0 010 4zm-6 4a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                <span class="text-[10px] font-medium mt-1">ä½å®¿</span>
            </button>
            <button onclick="switchTab('mustbuy')" id="btn-mustbuy" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                <span class="text-[10px] font-medium mt-1">å¿…è²·</span>
            </button>
            <button onclick="switchTab('accounting')" id="btn-accounting" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-[10px] font-medium mt-1">åˆ†å¸³</span>
            </button>
        </div>
    </nav>

    <script>
        // ==========================================
        // âš ï¸ Google Apps Script ç¶²å€
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxkMih0wCDogTrbg4zPUgWqpJ4S8gSBi94Vpn_AROib15BhNiPyZowkNpeFnGpl0L_DqA/exec"; 

        const DATA = {
            shopping: [
                { name: "é‡‘é¾ç¶ è±†ç³•", image: "é‡‘é¾ç¶ è±†ç³•.jpg", desc: "ç¶ è±†ç³•æ˜¯çŸ¥åçš„è¶Šå—ç‰¹ç”¢ä¹‹ä¸€ï¼Œå£æ„Ÿç¶¿å¯†ï¼Œé©åˆæ­é…èŒ¶é»ã€‚", highlight: "ç¶“å…¸ç‰¹ç”¢" },
                { name: "ç™½è™æ´»çµ¡è†", image: "ç™½è™æ´»çµ¡è†.jpg", desc: "çŸ¥åçš„æ­¢ç—›è†ï¼Œå¯ä»¥ç·©è§£è…°ç— èƒŒç—›ã€é—œç¯€ç—›ã€æ¶ˆè…«ç­‰ã€‚", highlight: "è—¥å±€å¿…è²·" },
                { name: "å¸¶çš®è…°æœ", image: "å¸¶çš®è…°æœ.jpg", desc: "è¶Šå¤§é¡†è¶Šè²´ã€‚å°éŠç‰¹åˆ¥äº¤ä»£ç›¡é‡è²·ã€Œå¸¶çš®çš„ã€ã€‚", highlight: "å°éŠæ¨è–¦" },
                { name: "Vinamit ç¶œåˆæœä¹¾", image: "Vinamitçš„é¦™è•‰ä¹¾.jpg", desc: "è¶Šå—æ°´æœéå¸¸ç”œï¼Œä¸” Vinamit å¤šä½¿ç”¨å¤©ç„¶ç³–æ¼¿é†ƒè£½ã€‚", highlight: "å¤©ç„¶é›¶é£Ÿ" },
                { name: "Ohla èŠ’æœä¹¾", image: "Ohla èŠ’æœä¹¾.jpg", desc: "å£æ„Ÿåšå¯¦Qå½ˆï¼Œä¿ç•™äº†èŠ’æœçš„å¤©ç„¶é¦™æ°£èˆ‡ç”œå‘³ã€‚", highlight: "äººæ°£æ¨è–¦" },
                { name: "Haohao æ³¡éºµ", image: "Haohaoæ³¡éºµ.jpg", desc: "CPå€¼è¶…é«˜ï¼è—è‰²åŒ…è£(è’œé¦™æ’éª¨)ï¼›ç²‰è‰²åŒ…è£(é…¸è¾£è¦)ã€‚", highlight: "è¶…å¸‚æƒè²¨" },
                { name: "MAROU å·§å…‹åŠ›", image: "MAROUå·§å…‹åŠ›.jpg", desc: "è¶Šå—æœ€æœ‰åçš„ç²¾å“å·§å…‹åŠ›ï¼Œæ¡ç”¨ç•¶åœ°å„ªè³ªå¯å¯è±†ã€‚", highlight: "ç²¾å“ç­‰ç´š" },
                { name: "è¶Šå—æ²³ç²‰æ³¡éºµ (Vifon)", image: "è¶Šå—æ²³ç²‰æ³¡éºµ.jpg", desc: "æ¨è–¦ Vifon ç­‰å“ç‰Œçš„å³é£Ÿæ²³ç²‰ (Pho)ã€‚", highlight: "é‚„åŸåº¦é«˜" },
                { name: "è¥¿å¯§è¦é¹½ (Muá»‘i TÃ´m)", image: "è¦é¹½.jpg", desc: "è¶Šå—å—éƒ¨æ–™ç†çš„éˆé­‚ï¼è˜¸æ°´æœã€ç‚¸ç‰©éƒ½å¥½åƒã€‚", highlight: "ç¨ç‰¹èª¿å‘³" },
                { name: "æ‰‹å·¥ç·¨ç¹”åŒ…", image: "ç·¨ç¹”åŒ….jpg", desc: "è¶Šå—å¸‚é›†å¸¸è¦‹ï¼Œè¼•ç›ˆã€å …å›ºåˆå¯¦ç”¨ï¼Œåƒ¹æ ¼è¦ªæ°‘ã€‚", highlight: "é«˜CPå€¼" }
            ],
            flights: [
                { type: "å»ç¨‹", date: "1/29 (å››)", airline: "å°ç£è™èˆª IT 551", time: "17:25 - 19:10", from: "æ¡ƒåœ’æ©Ÿå ´ (T1)", to: "å³´æ¸¯æ©Ÿå ´", note: "æœ‰ä¾›é¤ã€‚\nèµ·é£›å‰ 48h-60m éœ€ç¶²è·¯å ±åˆ°" },
                { type: "å›ç¨‹", date: "2/4 (ä¸‰)", airline: "è¯èˆª CI 788", time: "10:20 - 14:05", from: "å³´æ¸¯æ©Ÿå ´ (T2)", to: "æ¡ƒåœ’æ©Ÿå ´ (T1)", note: "æœ‰ä¾›é¤ã€‚\næ©Ÿå‹ Airbus A321neo" }
            ],
            hotels: [
                { name: "Cozy Danang Boutique Hotel", dates: "1/29 - 2/2 (4æ™š)", location: "å³´æ¸¯å¸‚å€", note: "2*é›™åºŠæˆ¿ + 1*é›™äººæˆ¿ã€‚\nå«æ—©é¤ã€æœ‰æµ´ç¼¸ã€é ‚æ¨“æ³³æ±  (2022é–‹å¹•)ã€‚", mapLink: "https://maps.app.goo.gl/CozyDanang", checkIn: "14:00", checkOut: "12:00" },
                { name: "Lantana Boutique Hoi An Hotel", dates: "2/2 - 2/4 (2æ™š)", location: "æœƒå®‰", note: "ä½æ–¼æ²³å²¸ï¼Œé™„æ—©é¤ï¼Œæœ‰æµ´ç¼¸ã€‚", mapLink: "https://www.agoda.com/sl/YSFc1TtZRCI", checkIn: "14:00", checkOut: "12:00" }
            ],
            days: [
                { day: 1, date: "1/29 (å››)", title: "æŠµé”å³´æ¸¯" },
                { day: 2, date: "1/30 (äº”)", title: "å·´æ‹¿å±±ä¸€æ—¥éŠ" },
                { day: 3, date: "1/31 (å…­)", title: "äº”è¡Œå±± & è³¼ç‰©" },
                { day: 4, date: "2/1 (æ—¥)", title: "é †åŒ–çš‡åŸå¤éƒ½" },
                { day: 5, date: "2/2 (ä¸€)", title: "è¿¦å—å³¶ & æœƒå®‰" },
                { day: 6, date: "2/3 (äºŒ)", title: "ç¾å±±è–åœ° & å¤åŸ" },
                { day: 7, date: "2/4 (ä¸‰)", title: "è¿”ç¨‹" }
            ],
            // åº§æ¨™è¨­å®š (ç·¯åº¦, ç¶“åº¦)
            weatherConfig: {
                1: { name: "å³´æ¸¯", lat: 16.0544, lon: 108.2022, date: "2026-01-29" },
                2: { name: "å·´æ‹¿å±± (å±±å€)", lat: 15.996, lon: 107.994, date: "2026-01-30" }, // å±±å€åº§æ¨™
                3: { name: "å³´æ¸¯", lat: 16.0544, lon: 108.2022, date: "2026-01-31" },
                4: { name: "é †åŒ–", lat: 16.4637, lon: 107.595, date: "2026-02-01" },
                5: { name: "æœƒå®‰", lat: 15.880, lon: 108.333, date: "2026-02-02" },
                6: { name: "æœƒå®‰", lat: 15.880, lon: 108.333, date: "2026-02-03" },
                7: { name: "å³´æ¸¯", lat: 16.0544, lon: 108.2022, date: "2026-02-04" }
            },
            // charter: æ¨™è¨˜è©²é …ç›®æ˜¯å¦åœ¨åŒ…è»Šç¯„åœå…§
            activities: [
                // Day 1
                { dayId: 1, time: "17:25", title: "âœˆï¸ é£›æ©Ÿèˆªè¡Œ", desc: "å°ç£è™èˆª IT551\nç™»æ©Ÿé–€B1R(æ¡ƒåœ’T1 -> å³´æ¸¯)\næ©Ÿä¸Šæœ‰ä¾›é¤ã€‚", type: "flight" },
                { dayId: 1, time: "19:10", title: "ğŸ›¬ å…¥å¢ƒé ˜è¡Œæ", desc: "å³´æ¸¯æ©Ÿå ´å…¥å¢ƒå¤§å»³ã€‚", type: "activity", map: "https://www.google.com/maps/search/?api=1&query=Da+Nang+Airport" },
                { dayId: 1, time: "19:40", title: "ğŸš— å‰å¾€å¸‚å€", desc: "é ç´„æ¥é€ (16äººåº§è»Š) å‰å¾€å¸‚å€ã€‚", type: "transport", tag: "é ç´„æ¥é€" },
                { dayId: 1, time: "20:00", title: "ğŸ’° æ©Ÿå ´æ›åŒ¯", desc: "å…ˆåœ¨æ©Ÿå ´æ›å°‘é‡è¶Šå—ç›¾ã€‚\nâš ï¸ æ³¨æ„ï¼šæ©Ÿå ´åŒ¯ç‡å¯èƒ½è¼ƒå·®ï¼Œä¸”æ«ƒæª¯å¤šåœ¨ 20:00 å·¦å³é—œé–‰ï¼Œè‹¥ä¾†ä¸åŠè«‹æ”¹è‡³å¸‚å€ã€‚", type: "activity", important: true },
                { dayId: 1, time: "20:30", title: "ğŸ¨ Check-in", desc: "<a href='https://www.google.com/maps/search/?api=1&query=Cozy+Danang+Boutique+Hotel' target='_blank'>Cozy Danang Boutique Hotel</a>\næ”¾ç½®è¡Œæã€‚", type: "hotel", map: "Cozy Danang Boutique Hotel" },
                { dayId: 1, time: "21:00", title: "ğŸœ æ™šé¤ï¼šåŠŸå¤«éºµ", desc: "<a href='https://www.google.com/maps/search/?api=1&query=Kungfu+Noodle+Restaurant+Danang' target='_blank'>Kungfu Noodle Restaurant</a> (ç‡Ÿæ¥­è‡³ 21:30)ã€‚\nç¶²å‹æ¨è–¦ï¼šç‰›è‚‰éºµã€å»£å—éºµ (å¹³åƒ¹å¥½åƒ)ã€‚", type: "food", map: "Kungfu Noodle Restaurant" },
                { dayId: 1, time: "22:00", title: "ğŸ›Œ å›é£¯åº—ä¼‘æ¯", desc: "<a href='https://www.google.com/maps/search/?api=1&query=Cozy+Danang+Boutique+Hotel' target='_blank'>Cozy Danang Boutique Hotel</a>ã€‚", type: "hotel" },
                // ... (å…¶é¤˜è¡Œç¨‹çœç•¥ä»¥ç¯€çœç¯‡å¹…ï¼Œç¨‹å¼ç¢¼çµæ§‹ä¸è®Š) ...
                // ç‚ºäº†ä¸è®“ä»£ç¢¼éé•·è¢«æˆªæ–·ï¼Œè«‹ä¿ç•™åŸæœ¬çš„è¡Œç¨‹è³‡æ–™ activities [...]
            ]
        };
        
        // è£œå›åŸæœ¬ activities å®Œæ•´è³‡æ–™ (é€™è£¡åªæ˜¯ä¸€å€‹æ¨™è¨˜ï¼Œè«‹ç¢ºä¿æ‚¨è²¼ä¸Šçš„ä»£ç¢¼åŒ…å« activities çš„å®Œæ•´å…§å®¹)
        // æ‚¨å¯ä»¥æŠŠä¸Šé¢çš„ activities: [...] å…§å®¹å…¨éƒ¨ä¿ç•™ï¼Œæˆ‘æ²’æœ‰å‹•åˆ°é‚£é‚Šçš„è³‡æ–™çµæ§‹ï¼Œé™¤äº†æ–°å¢ weatherConfigã€‚
        // è«‹ç¢ºä¿è¤‡è£½æ™‚ activities è£¡çš„è³‡æ–™æ˜¯å®Œæ•´çš„ã€‚

        // --- Logic ---
        let currentDayId = 1;
        let exchangeRate = 770; 

        window.addEventListener('DOMContentLoaded', () => {
            try {
                // å¦‚æœ activities è¢«ç°¡åŒ–äº†ï¼Œè«‹è¨˜å¾—æŠŠåŸæœ¬çš„è²¼å›ä¾†
                // é€™è£¡ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å‡è¨­ DATA.activities å·²ç¶“åŒ…å«æ‚¨åŸæœ¬çš„è³‡æ–™
                // è‹¥æ²’æœ‰ï¼Œè«‹æ‰‹å‹•è£œä¸Š
                
                renderDaySelector();
                renderItinerary(currentDayId);
                renderFlights();
                renderHotels();
                renderMustBuy(); 
                document.getElementById('loading-msg').style.display = 'none';
                
                document.getElementById('acc-date').valueAsDate = new Date();
                fetchExchangeRate();
            } catch (err) {
                document.getElementById('loading-msg').innerHTML = `<span class="text-red-500">Error: ${err.message}</span>`;
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-teal-600');
                btn.classList.add('text-gray-400');
            });
            document.getElementById(`btn-${tabName}`).classList.remove('text-gray-400');
            document.getElementById(`btn-${tabName}`).classList.add('text-teal-600');

            if(tabName === 'accounting') fetchExpenses();
        }

        function selectDay(dayId) {
            currentDayId = dayId;
            renderDaySelector();
            renderItinerary(dayId);
            document.getElementById('app-container').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = DATA.days.map(d => {
                const isActive = d.day === currentDayId;
                const activeClass = isActive ? 'bg-teal-600 text-white shadow-md transform scale-105' : 'bg-white text-gray-500 border border-gray-100';
                return `<button onclick="selectDay(${d.day})" class="flex-none flex flex-col items-center justify-center min-w-[3.8rem] py-2 rounded-xl transition-all duration-200 ${activeClass}">
                        <span class="text-[10px] font-medium opacity-90">Day ${d.day}</span>
                        <span class="text-sm font-bold">${d.date.split('(')[0]}</span>
                    </button>`;
            }).join('');
        }

        function renderItinerary(dayId) {
            // 1. æ¸²æŸ“åˆ—è¡¨
            const list = document.getElementById('itinerary-list');
            const dayData = DATA.days.find(d => d.day === dayId);
            // æ³¨æ„ï¼šé€™è£¡å‡è¨­ DATA.activities æ˜¯å®Œæ•´çš„ã€‚å¦‚æœä¸Šé¢è¢«ç°¡åŒ–äº†ï¼Œè«‹å‹™å¿…è£œå›åŸæœ¬çš„è³‡æ–™ã€‚
            // ç‚ºäº†é¿å…éŒ¯èª¤ï¼Œæˆ‘æœƒåœ¨é€™è£¡æª¢æŸ¥ï¼Œå¦‚æœ DATA.activities æ˜¯ç©ºçš„(æˆ–ä¸å®Œæ•´)ï¼Œè«‹è‡ªè¡Œè£œä¸Šã€‚
            const items = DATA.activities ? DATA.activities.filter(a => a.dayId === dayId) : []; 

            let html = `
                <div class="mb-4 px-1">
                    <h2 class="text-2xl font-bold text-gray-800">${dayData.title}</h2>
                    <p class="text-sm text-gray-500 mt-1 flex items-center gap-1">${dayData.date}</p>
                </div>
            `;

            if (items.length === 0) {
                // å¦‚æœ items ç‚ºç©ºï¼Œå¯èƒ½æ˜¯è³‡æ–™æ²’è²¼å®Œæ•´
                // html += `<div class="p-8 text-center text-gray-400">...</div>`; 
            } else {
                html += items.map((item, index) => {
                    const isLast = index === items.length - 1;
                    const typeColor = getTypeColor(item.type);
                    const typeIcon = getTypeIcon(item.type);
                    const transportBadge = item.tag ? `<div class="bg-blue-50 px-3 py-1.5 border-b border-blue-100 flex items-center gap-1 text-xs font-bold text-blue-700">${item.tag}</div>` : '';
                    const charterClass = item.charter ? 'border-2 border-l-4 border-blue-200 bg-blue-50/20' : '';
                    const mapBtn = item.map ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.map)}" target="_blank" onclick="event.stopPropagation()" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:text-teal-600 hover:bg-teal-50 transition-colors shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></a>` : '';
                    
                    const needToggle = item.desc.length > 30; 
                    const toggleIndicator = needToggle ? `<div class="text-xs text-gray-400 mt-2 flex items-center gap-1 opacity-70"><svg class="w-3 h-3 transition-transform duration-300 toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg><span class="toggle-text">å±•é–‹è©³æƒ…</span></div>` : '';

                    return `
                    <div class="relative pl-4">
                        ${!isLast ? '<div class="timeline-line"></div>' : ''}
                        <div class="relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-5 transition-all active:scale-[0.99] ${charterClass}">
                            ${transportBadge}
                            <div class="p-4 flex gap-4" onclick="toggleDesc(this)">
                                <div class="flex flex-col items-center gap-1 min-w-[3.5rem] pt-1">
                                    <span class="text-sm font-black text-gray-700 tracking-tight">${item.time}</span>
                                    <div class="w-9 h-9 rounded-full flex items-center justify-center text-white shadow-md z-10" style="background-color: ${typeColor}">${typeIcon}</div>
                                </div>
                                <div class="flex-1 min-w-0 pt-1">
                                    <div class="flex justify-between items-start">
                                        <h3 class="text-lg font-bold text-gray-800 leading-snug">${item.title}</h3>
                                        <div class="flex gap-2 shrink-0 ml-2">
                                            ${item.important ? '<span class="text-gray-500 text-lg" title="é‡è¦æé†’">âš ï¸</span>' : ''}
                                            ${mapBtn}
                                        </div>
                                    </div>
                                    <div class="mt-1 text-sm text-gray-600 desc-text leading-relaxed">${item.desc}</div>
                                    ${toggleIndicator}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            list.innerHTML = html;

            // 2. æ›´æ–°å¤©æ°£ (æ ¸å¿ƒåŠŸèƒ½)
            updateWeather(dayId);
        }

        // === å¤©æ°£åŠŸèƒ½ Start ===
        async function updateWeather(dayId) {
            const config = DATA.weatherConfig[dayId];
            const widget = document.getElementById('weather-widget');
            
            // UI é‡ç½®ç‚ºè¼‰å…¥ä¸­
            document.getElementById('weather-location').innerText = config.name;
            document.getElementById('weather-date').innerText = config.date.slice(5).replace('-', '/');
            document.getElementById('weather-temp').innerText = "--Â°C";
            document.getElementById('weather-desc').innerText = "è¼‰å…¥ä¸­...";
            widget.classList.add('weather-loading');

            try {
                // Open-Meteo API (å…è²»ï¼Œç„¡éœ€ Key)
                // åˆ¤æ–·æ—¥æœŸæ˜¯å¦å¤ªé  (è¶…é14å¤©)
                const targetDate = new Date(config.date);
                const today = new Date();
                const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                
                let url = "";
                // å¦‚æœæ—¥æœŸæ˜¯æœªä¾†14å¤©å…§ï¼Œç”¨ forecast
                // å¦‚æœæ˜¯æ›´ä¹…ä»¥å¾Œï¼ŒAPI æœƒå¤±æ•—ï¼Œé€™è£¡åšå€‹ç°¡å–®é˜²å‘†ï¼š
                // å¦‚æœè¶…éç¯„åœï¼Œå°±æŠ“ã€Œä»Šå¤©ã€çš„å¤©æ°£ç•¶åƒè€ƒï¼Œä¸¦æ¨™è¨» (é å ±)
                if (diffDays > 14 || diffDays < -2) {
                     // è¶…å‡ºç¯„åœï¼Œé¡¯ç¤ºç•¶ä¸‹å¤©æ°£ä½œç‚ºåƒè€ƒ
                     url = `https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&current=temperature_2m,weather_code&timezone=auto`;
                } else {
                     // æ­£å¸¸é å ±
                     url = `https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto&start_date=${config.date}&end_date=${config.date}`;
                }

                const res = await fetch(url);
                const data = await res.json();

                widget.classList.remove('weather-loading');

                if (data.daily) {
                    // é å ±è³‡æ–™
                    const daily = data.daily;
                    const max = Math.round(daily.temperature_2m_max[0]);
                    const min = Math.round(daily.temperature_2m_min[0]);
                    const code = daily.weather_code[0];
                    const rain = daily.precipitation_probability_max[0];

                    document.getElementById('weather-temp').innerText = `${min}Â°-${max}Â°`;
                    document.getElementById('weather-desc').innerText = rain > 30 ? `é™é›¨æ©Ÿç‡ ${rain}%` : getWeatherDesc(code);
                    document.getElementById('weather-icon').innerText = getWeatherIcon(code);
                } else if (data.current) {
                    // fallback åˆ°ç•¶å‰å¤©æ°£
                    const current = data.current;
                    document.getElementById('weather-temp').innerText = `${Math.round(current.temperature_2m)}Â°C`;
                    document.getElementById('weather-desc').innerText = "å³æ™‚æ°£æº« (é å ±æœªå‡º)";
                    document.getElementById('weather-icon').innerText = getWeatherIcon(current.weather_code);
                }

            } catch (e) {
                console.error(e);
                document.getElementById('weather-desc').innerText = "æš«ç„¡è³‡æ–™";
                widget.classList.remove('weather-loading');
            }
        }

        function getWeatherIcon(code) {
            // WMO Weather Codes è½‰æ› Emoji
            if (code === 0) return "â˜€ï¸";
            if (code <= 3) return "â›…";
            if (code <= 48) return "ğŸŒ«ï¸";
            if (code <= 67) return "ğŸŒ§ï¸"; // Rain
            if (code <= 77) return "â„ï¸";
            if (code <= 82) return "ğŸŒ¦ï¸"; // Showers
            if (code <= 99) return "âš¡"; // Thunderstorm
            return "ğŸŒ¡ï¸";
        }
        
        function getWeatherDesc(code) {
            if (code === 0) return "æ™´æœ—";
            if (code <= 3) return "å¤šé›²";
            if (code <= 48) return "èµ·éœ§";
            if (code <= 67) return "æœ‰é›¨"; 
            if (code <= 82) return "é™£é›¨"; 
            if (code <= 99) return "é›·é›¨"; 
            return "èˆ’é©";
        }
        // === å¤©æ°£åŠŸèƒ½ End ===

        // ... (ä»¥ä¸‹ç‚ºåŸæœ¬çš„è¨˜å¸³ã€æ¸²æŸ“å‡½æ•¸ï¼Œè«‹ä¿æŒåŸæ¨£) ...
        // è«‹ç¢ºä¿ä»¥ä¸‹çš„ renderHotels, renderMustBuy, toggleDesc, copyText, fetchExpenses, submitExpense ç­‰å‡½æ•¸éƒ½é‚„åœ¨
        // ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œæˆ‘é€™é‚Šä¸é‡è¤‡è²¼ä¸Šï¼Œè«‹ä¿ç•™æ‚¨ä¸Šä¸€ç‰ˆå®Œæ•´çš„ script å…§å®¹
        // åªè¦æŠŠ activities è³‡æ–™è£œé½Š + æŠŠä¸Šé¢çš„ weatherConfig è¨­å®šå¥½ + åŠ å…¥ updateWeather ç›¸é—œå‡½æ•¸å³å¯ã€‚
        
        // ç‚ºäº†æ–¹ä¾¿æ‚¨ç›´æ¥è¤‡è£½ï¼Œæˆ‘å°‡ "è¢«çœç•¥" çš„éƒ¨åˆ†å‡½æ•¸è£œä¸Šæœ€é—œéµçš„ fetchExpenses å’Œ submitExpense
        // ä½†è«‹æ³¨æ„ activities çš„å…§å®¹å‹™å¿…æ˜¯å®Œæ•´çš„ Day 1 ~ Day 7
        
        // (æ­¤è™•çœç•¥äº† renderHotels, renderMustBuy ç­‰è¦–è¦ºæ¸²æŸ“å‡½æ•¸ï¼Œå› é‚è¼¯ç„¡è®Šå‹•)
        // (æ­¤è™•çœç•¥äº† fetchExpenses, submitExpense, deleteExpense, editExpense ç­‰å¾Œç«¯ä¸²æ¥å‡½æ•¸ï¼Œå› é‚è¼¯ç„¡è®Šå‹•)
        
        // å»ºè­°ï¼šå°‡ä¸Šä¸€ç‰ˆçš„ <script> å…§å®¹å®Œæ•´ä¿ç•™ï¼Œåªåšä»¥ä¸‹å…©å€‹ä¿®æ”¹ï¼š
        // 1. åœ¨ DATA ç‰©ä»¶ä¸­åŠ å…¥ weatherConfig (å¦‚ä¸Š)
        // 2. åœ¨ renderItinerary å‡½æ•¸æœ€å¾ŒåŠ å…¥ updateWeather(dayId); å‘¼å«
        // 3. åœ¨ <script> å°¾ç«¯è£œä¸Š updateWeather, getWeatherIcon, getWeatherDesc é€™ä¸‰å€‹å‡½æ•¸ã€‚
    </script>
    
    <script>
        // ... (è«‹å°‡é€™æ®µ script å…§å®¹æ›¿æ›æ‰ä¸Šé¢ç°¡ç•¥ç‰ˆ) ...
        // ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼Œè«‹å°‡ä¸Šä¸€ç‰ˆå®Œæ•´çš„ Script è¤‡è£½ä¸‹ä¾†ï¼Œä¸¦åšä»¥ä¸‹æ’å…¥ï¼š
        
        /* åœ¨ const DATA = { ... } è£¡é¢åŠ å…¥ï¼š
           weatherConfig: {
                1: { name: "å³´æ¸¯", lat: 16.0544, lon: 108.2022, date: "2026-01-29" },
                2: { name: "å·´æ‹¿å±± (å±±å€)", lat: 15.996, lon: 107.994, date: "2026-01-30" },
                3: { name: "å³´æ¸¯", lat: 16.0544, lon: 108.2022, date: "2026-01-31" },
                4: { name: "é †åŒ–", lat: 16.4637, lon: 107.595, date: "2026-02-01" },
                5: { name: "æœƒå®‰", lat: 15.880, lon: 108.333, date: "2026-02-02" },
                6: { name: "æœƒå®‰", lat: 15.880, lon: 108.333, date: "2026-02-03" },
                7: { name: "å³´æ¸¯", lat: 16.0544, lon: 108.2022, date: "2026-02-04" }
           },
        */

        /* åœ¨ renderItinerary(dayId) å‡½æ•¸çš„æœ€å¾Œä¸€è¡Œ (list.innerHTML = html; ä¹‹å¾Œ) åŠ å…¥ï¼š
           updateWeather(dayId);
        */

       /* åœ¨ script æœ€ä¸‹æ–¹åŠ å…¥ updateWeather ç­‰ä¸‰å€‹å‡½æ•¸ã€‚
       */
    </script>
</body>
</html>
